<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ujian Online CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --success: #28a745;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; padding: 20px; color: var(--text-dark); }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* === HALAMAN 1: IDENTITAS (DIBUAT SANGAT JELAS) === */
        #halaman-identitas { 
            display: block; /* Pastikan muncul */
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            text-align: left;
        }

        .judul-halaman { text-align: center; color: var(--primary); margin-bottom: 30px; font-weight: 800; font-size: 24px; }
        
        /* STYLE INPUT YANG LEBIH TEGAS */
        .form-group { margin-bottom: 25px; }
        .form-label { 
            display: block; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: #333; 
            font-size: 16px;
        }
        .form-input { 
            width: 100%; 
            padding: 15px; 
            font-size: 16px; 
            border: 2px solid #ccc; /* Garis Jelas */
            border-radius: 8px; 
            background-color: #fff;
            box-sizing: border-box; /* Agar tidak melebar */
            transition: 0.3s;
        }
        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
        }

        .btn-mulai { 
            width: 100%; padding: 18px; background: var(--primary); color: white; 
            border: none; border-radius: 10px; font-weight: 800; font-size: 18px; cursor: pointer; 
            margin-top: 10px; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        /* === HALAMAN 2: UJIAN (HIDDEN DEFAULT) === */
        #halaman-ujian { display: none; }
        
        .header-cbt { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .progress-container { width: 100%; background: #eee; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: 0.3s; }
        
        /* SOAL CARD */
        .soal-card { 
            display: none; background: white; padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
            text-align: left;
        }
        .soal-card.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nomor-soal { display: inline-block; background: #eef2ff; color: var(--primary); padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px; margin-bottom: 15px; }
        .pertanyaan { font-size: 18px; font-weight: 600; margin-bottom: 25px; line-height: 1.6; }

        /* OPSI JAWABAN */
        .opsi-label { display: flex; align-items: center; padding: 15px; margin-bottom: 12px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opsi-label:hover { background: #f8f9fa; border-color: #bbb; }
        .opsi-label::before { content: ''; display: block; width: 20px; height: 20px; margin-right: 15px; border: 2px solid #999; border-radius: 50%; background: white; flex-shrink: 0; }
        .checkbox-label::before { border-radius: 4px; }
        
        input:checked + .opsi-label { background: #e7f5ff; border-color: var(--primary); font-weight: 600; color: var(--primary); }
        input:checked + .opsi-label::before { background: var(--primary); border-color: var(--primary); box-shadow: inset 0 0 0 3px white; }
        input[type="radio"], input[type="checkbox"] { display: none; } /* Hide default */

        /* NAVIGASI */
        .nav-box { display: flex; gap: 10px; margin-top: 25px; }
        .btn-nav { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-prev { background: #e9ecef; color: #555; }
        .btn-next { background: var(--primary); color: white; }
        .btn-submit { background: var(--success); color: white; display: none; }

        /* TABEL MENJODOHKAN */
        .table-jodoh { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .table-jodoh td, .table-jodoh th { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .table-jodoh td:first-child { text-align: left; background: #fafafa; font-weight: bold; width: 40%; }
        .radio-jodoh { display: inline-block !important; transform: scale(1.5); }
    </style>
</head>
<body>

<div class="container">

    <div id="halaman-identitas">
        <h2 class="judul-halaman">üìù Data Peserta</h2>
        <p style="text-align:center; color:#666; margin-bottom:30px;" id="judul-mapel-display">Memuat Info Ujian...</p>
        
        <form id="formIdentitas">
            <div class="form-group">
                <label class="form-label">NAMA LENGKAP:</label>
                <input type="text" id="inputNama" class="form-input" placeholder="Ketik Nama Lengkap Anda..." required>
            </div>

            <div class="form-group">
                <label class="form-label">KELAS:</label>
                <select id="inputKelas" class="form-input" required>
                    <option value="">-- Pilih Kelas --</option>
                    <option value="10-1">10-1</option>
                    <option value="10-2">10-2</option>
                    <option value="10-3">10-3</option>
                    <option value="10-4">10-4</option>
                </select>
            </div>

            <button type="button" class="btn-mulai" onclick="bukaSoal()">MULAI KERJAKAN ‚ñ∂</button>
        </form>
    </div>

    <div id="halaman-ujian">
        <div class="header-cbt">
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:#555;">
                <span id="info-mapel">MAPEL</span>
                <span id="counter-soal">Soal 1 / 10</span>
            </div>
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        </div>

        <form id="formUjian">
            <div id="area-soal"></div> <div class="nav-box">
                <button type="button" class="btn-nav btn-prev" id="btnPrev" onclick="gantiSoal(-1)">Kembali</button>
                <button type="button" class="btn-nav btn-next" id="btnNext" onclick="gantiSoal(1)">Selanjutnya ‚ùØ</button>
                <button type="submit" class="btn-nav btn-submit" id="btnSubmit">KIRIM JAWABAN ‚úÖ</button>
            </div>
        </form>
    </div>

</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è PASTE LINK GOOGLE SCRIPT DISINI
    // ==========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx...PASTE_URL_DISINI.../exec'; 

    let currentIdx = 0;
    let totalSoal = 0;
    
    // 1. AMBIL SOAL DARI JSON
    const urlParams = new URLSearchParams(window.location.search);
    const namaFile = urlParams.get('file');

    if(namaFile) {
        const judul = namaFile.replace('.json', '').replace(/_/g, ' ').toUpperCase();
        document.getElementById('judul-mapel-display').innerText = "Ujian: " + judul;
        document.getElementById('info-mapel').innerText = judul;

        fetch(namaFile)
            .then(res => res.json())
            .then(data => {
                totalSoal = data.length;
                renderSoal(data);
            })
            .catch(err => alert("Gagal memuat soal. Cek nama file JSON!"));
    }

    // 2. RENDER SEMUA SOAL (TAPI DISEMBUNYIKAN)
    function renderSoal(data) {
        const area = document.getElementById('area-soal');
        area.innerHTML = '';

        data.forEach((item, index) => {
            let activeClass = (index === 0) ? 'active' : '';
            
            let html = `
            <div class="soal-card ${activeClass}" id="card-${index}">
                <span class="nomor-soal">Nomor ${index + 1}</span>
                <div class="pertanyaan">${item.tanya}</div>
                <div class="opsi-container">`;

            // RENDER OPSI
            if(item.jenis === 'essay') {
                html += `<textarea name="soal_${item.id}" class="form-input" rows="5" placeholder="Jawab disini..."></textarea>`;
            } 
            else if(item.jenis === 'jodoh') {
                html += `<table class="table-jodoh"><thead><tr><th>Pernyataan</th>`;
                item.respon.forEach(r => html += `<th>${r}</th>`);
                html += `</tr></thead><tbody>`;
                item.premis.forEach((p, rIdx) => {
                    html += `<tr><td>${p}</td>`;
                    item.respon.forEach(r => html += `<td><input type="radio" class="radio-jodoh" name="soal_${item.id}_row_${rIdx}" value="${p}=${r}"></td>`);
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
            }
            else if(item.jenis === 'kompleks') { // Checkbox
                item.opsi.forEach((opt, i) => {
                    html += `<label class="opsi-label checkbox-label">
                                <input type="checkbox" name="soal_${item.id}" value="${opt}">
                                ${opt}
                             </label>`;
                });
            }
            else { // PG / BS (Radio)
                item.opsi.forEach((opt, i) => {
                    html += `<label class="opsi-label">
                                <input type="radio" name="soal_${item.id}" value="${opt}">
                                ${opt}
                             </label>`;
                });
            }

            html += `</div></div>`;
            area.innerHTML += html;
        });
    }

    // 3. LOGIKA PINDAH HALAMAN
    function bukaSoal() {
        const nama = document.getElementById('inputNama').value;
        const kelas = document.getElementById('inputKelas').value;
        if(!nama || !kelas) { alert("‚ö†Ô∏è Mohon isi Nama dan Kelas dulu!"); return; }

        document.getElementById('halaman-identitas').style.display = 'none';
        document.getElementById('halaman-ujian').style.display = 'block';
        updateNav();
    }

    function gantiSoal(n) {
        // Validasi: Harus diisi sebelum Next
        if(n === 1 && !cekTerisi(currentIdx)) {
            alert("‚ö†Ô∏è Jawab dulu soal ini sebelum lanjut!");
            return;
        }

        document.getElementById(`card-${currentIdx}`).classList.remove('active');
        currentIdx += n;
        document.getElementById(`card-${currentIdx}`).classList.add('active');
        updateNav();
    }

    function updateNav() {
        document.getElementById('counter-soal').innerText = `Soal ${currentIdx + 1} / ${totalSoal}`;
        document.getElementById('progressBar').style.width = `${((currentIdx+1)/totalSoal)*100}%`;

        document.getElementById('btnPrev').disabled = (currentIdx === 0);
        document.getElementById('btnPrev').style.opacity = (currentIdx === 0) ? 0.5 : 1;

        if(currentIdx === totalSoal - 1) {
            document.getElementById('btnNext').style.display = 'none';
            document.getElementById('btnSubmit').style.display = 'block';
        } else {
            document.getElementById('btnNext').style.display = 'block';
            document.getElementById('btnSubmit').style.display = 'none';
        }
    }

    function cekTerisi(idx) {
        const card = document.getElementById(`card-${idx}`);
        const inputs = card.querySelectorAll('input:checked, textarea');
        let isFilled = false;
        if(inputs.length > 0) {
            inputs.forEach(inp => {
                if(inp.type === 'textarea' && inp.value.trim() !== '') isFilled = true;
                else if(inp.type !== 'textarea') isFilled = true;
            });
        }
        // Cek Textarea manual karena querySelectorAll :checked ga nangkep textarea
        const txt = card.querySelector('textarea');
        if(txt && txt.value.trim() !== '') isFilled = true;
        
        return isFilled;
    }

    // 4. KIRIM DATA
    document.getElementById('formUjian').addEventListener('submit', e => {
        e.preventDefault();
        if(!confirm("Kirim Jawaban?")) return;

        const btn = document.getElementById('btnSubmit');
        btn.innerHTML = "‚è≥ Mengirim...";
        btn.disabled = true;

        const formData = new FormData(document.getElementById('formUjian'));
        const finalData = new FormData();

        // Identitas
        finalData.append('Waktu', new Date().toLocaleString());
        finalData.append('Nama', document.getElementById('inputNama').value);
        finalData.append('Kelas', document.getElementById('inputKelas').value);
        finalData.append('Mapel', document.getElementById('info-mapel').innerText);

        // Jawaban (Logic Gabung Checkbox/Jodoh)
        const entries = formData.entries();
        const processedKeys = new Set();
        for(let [key, value] of entries) {
            let mainKey = key.includes('_row_') ? key.split('_row_')[0] : key;
            if(processedKeys.has(mainKey)) continue;

            const allVal = formData.getAll(key);
            if(key.includes('_row_')) { // Jodoh
                let arr = [];
                document.querySelectorAll(`input[name^="${mainKey}"]:checked`).forEach(el => arr.push(el.value));
                finalData.append(mainKey, arr.join(', '));
            } else if(allVal.length > 1) {
                finalData.append(key, allVal.join(', '));
            } else {
                finalData.append(key, value);
            }
            processedKeys.add(mainKey);
        }

        fetch(scriptURL, { method: 'POST', body: finalData})
            .then(() => { alert("‚úÖ Terkirim!"); window.location.href = "tugas.html"; })
            .catch(() => { alert("‚ùå Gagal!"); btn.disabled = false; btn.innerHTML = "Coba Lagi"; });
    });
</script>

</body>
</html>
