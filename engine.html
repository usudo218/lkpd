<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ujian Online CBT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #6c757d;
            --success: #28a745;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; padding: 20px; color: var(--text-dark); }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* HEADER & PROGRESS BAR */
        .header-cbt { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .progress-container { width: 100%; background-color: #e9ecef; height: 10px; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--success); width: 0%; transition: width 0.3s ease; }
        .info-soal { display: flex; justify-content: space-between; font-weight: 600; font-size: 14px; color: #555; }

        /* IDENTITAS (Hanya muncul di awal) */
        #halaman-identitas { display: block; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; }
        .btn-mulai { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* SOAL CARD (Disembunyikan Default) */
        .soal-card { 
            display: none; /* RAHASIA: Default sembunyi */
            background: white; padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; 
            text-align: left; border-left: 5px solid var(--primary); animation: fadeIn 0.4s;
        }
        .soal-card.active { display: block; } /* Hanya yang aktif yang muncul */

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nomor-soal { display: inline-block; background: #eef2ff; color: var(--primary); padding: 5px 12px; border-radius: 6px; font-weight: 700; font-size: 13px; margin-bottom: 15px; }
        .pertanyaan { font-size: 17px; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }

        /* OPSI JAWABAN */
        .opsi-label { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 10px; background: white; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .opsi-label:hover { background: #f8f9fa; }
        .opsi-label::before { content: ''; display: inline-block; width: 18px; height: 18px; margin-right: 15px; border: 2px solid #adb5bd; border-radius: 50%; background: white; flex-shrink: 0; }
        .checkbox-label::before { border-radius: 4px; }
        input[type="radio"]:checked + .opsi-label, input[type="checkbox"]:checked + .opsi-label { background: #e7f5ff; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        input[type="radio"]:checked + .opsi-label::before, input[type="checkbox"]:checked + .opsi-label::before { background: var(--primary); border-color: var(--primary); box-shadow: inset 0 0 0 3px white; }
        input { display: none; } /* Sembunyikan radio asli */

        /* TOMBOL NAVIGASI (Next/Prev) */
        .nav-box { display: none; justify-content: space-between; gap: 10px; margin-top: 20px; }
        .btn-nav { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-prev { background: #e9ecef; color: #495057; }
        .btn-next { background: var(--primary); color: white; }
        .btn-submit { background: var(--success); color: white; display: none; } /* Muncul di akhir */
        
        .table-jodoh { width: 100%; border-collapse: collapse; margin-top:10px; }
        .table-jodoh td, .table-jodoh th { border: 1px solid #eee; padding: 8px; text-align: center; }
        .table-jodoh td:first-child { text-align: left; width: 40%; font-weight: bold; }
        .radio-jodoh { display: inline-block; transform: scale(1.3); } /* Radio tabel tetap muncul */
    </style>
</head>
<body>

<div class="container">
    
    <div id="halaman-identitas">
        <h2 style="text-align:center; color:var(--primary);">üìù Identitas Peserta</h2>
        <p style="text-align:center; margin-bottom:30px; color:#666;" id="judul-mapel">Memuat Ujian...</p>
        
        <form id="formIdentitas">
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="inputNama" class="form-input" required placeholder="Contoh: Budi Santoso">
            </div>
            <div class="form-group">
                <label>Kelas</label>
                <select id="inputKelas" class="form-input" required>
                    <option value="">-- Pilih Kelas --</option>
                    <option value="10-1">10-1</option>
                    <option value="10-2">10-2</option>
                    <option value="10-3">10-3</option>
                    <option value="10-4">10-4</option>
                </select>
            </div>
            <button type="button" class="btn-mulai" onclick="mulaiUjian()">MULAI MENGERJAKAN ‚ñ∂</button>
        </form>
    </div>

    <div id="halaman-ujian" style="display:none;">
        <div class="header-cbt">
            <div class="info-soal">
                <span id="mapel-label">MAPEL</span>
                <span id="counter-soal">Soal 1 / 10</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <form id="formUjian">
            <div id="area-soal"></div>

            <div class="nav-box" id="navBox">
                <button type="button" class="btn-nav btn-prev" id="btnPrev" onclick="gantiSoal(-1)">Kembali</button>
                <button type="button" class="btn-nav btn-next" id="btnNext" onclick="gantiSoal(1)">Selanjutnya ‚ùØ</button>
                <button type="submit" class="btn-nav btn-submit" id="btnSubmit">Kirim Jawaban ‚úÖ</button>
            </div>
        </form>
    </div>

</div>

<script>
    // ===========================================
    // ‚ö†Ô∏è GANTI LINK GOOGLE SCRIPT DISINI
    // ===========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx...PASTE_URL_DISINI.../exec'; 

    let currentSoalIndex = 0;
    let totalSoal = 0;
    let dataSoal = [];

    // 1. LOAD SOAL SAAT WEB DIBUKA
    const urlParams = new URLSearchParams(window.location.search);
    const namaFile = urlParams.get('file');

    if(namaFile) {
        const judul = namaFile.replace('.json', '').replace(/_/g, ' ').toUpperCase();
        document.getElementById('judul-mapel').innerText = judul;
        document.getElementById('mapel-label').innerText = judul;

        fetch(namaFile)
            .then(res => res.json())
            .then(data => {
                dataSoal = data;
                totalSoal = data.length;
                renderSoal(data);
            })
            .catch(err => alert("Gagal memuat soal: " + err));
    }

    // 2. FUNGSI RENDER HTML
    function renderSoal(data) {
        const area = document.getElementById('area-soal');
        area.innerHTML = ''; 
        
        data.forEach((item, index) => {
            // Tambahkan class 'active' hanya untuk soal pertama
            let status = (index === 0) ? 'active' : ''; 
            
            let html = `
            <div class="soal-card ${status}" id="soal-index-${index}" data-id="${item.id}" data-type="${item.jenis}">
                <span class="nomor-soal">Nomor ${index + 1}</span>
                <div class="pertanyaan">${item.tanya}</div>
                <div class="opsi-container">`;

            // RENDER OPSI (Sama seperti sebelumnya)
            if(item.jenis === 'essay'){
                html += `<textarea name="soal_${item.id}" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc" rows="4"></textarea>`;
            } 
            else if(item.jenis === 'kompleks'){
                item.opsi.forEach((opt, i) => {
                    html += `<input type="checkbox" id="c_${item.id}_${i}" name="soal_${item.id}" value="${opt}">
                             <label class="opsi-label checkbox-label" for="c_${item.id}_${i}">${opt}</label>`;
                });
            } 
            else if(item.jenis === 'jodoh'){
                html += `<table class="table-jodoh"><thead><tr><th>Pernyataan</th>`;
                item.respon.forEach(res => html += `<th>${res}</th>`);
                html += `</tr></thead><tbody>`;
                item.premis.forEach((prem, r) => {
                    html += `<tr><td>${prem}</td>`;
                    item.respon.forEach(res => html += `<td><input type="radio" class="radio-jodoh" name="soal_${item.id}_row_${r}" value="${prem}=${res}"></td>`);
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
            } 
            else { // PG / BS
                item.opsi.forEach((opt, i) => {
                    html += `<input type="radio" id="r_${item.id}_${i}" name="soal_${item.id}" value="${opt}">
                             <label class="opsi-label" for="r_${item.id}_${i}">${opt}</label>`;
                });
            }
            html += `</div></div>`;
            area.innerHTML += html;
        });
    }

    // 3. FUNGSI PINDAH HALAMAN (KUNCI UTAMA)
    function mulaiUjian() {
        const nama = document.getElementById('inputNama').value;
        const kelas = document.getElementById('inputKelas').value;
        if(nama === "" || kelas === "") { alert("Isi nama dan kelas dulu!"); return; }

        document.getElementById('halaman-identitas').style.display = 'none';
        document.getElementById('halaman-ujian').style.display = 'block';
        document.getElementById('navBox').style.display = 'flex';
        updateUI();
    }

    function gantiSoal(n) {
        // Validasi: Cek apakah soal sekarang sudah diisi sebelum lanjut
        if(n === 1) { // Kalau mau klik Next
            if(!cekJawabanTerisi(currentSoalIndex)) {
                alert("‚ö†Ô∏è Anda belum menjawab soal ini!");
                return;
            }
        }

        // Sembunyikan soal lama
        document.getElementById(`soal-index-${currentSoalIndex}`).classList.remove('active');
        
        // Update Index
        currentSoalIndex += n;
        
        // Tampilkan soal baru
        document.getElementById(`soal-index-${currentSoalIndex}`).classList.add('active');
        updateUI();
    }

    function updateUI() {
        // Update Tombol
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const btnSubmit = document.getElementById('btnSubmit');

        // Tombol Back mati di soal pertama
        btnPrev.disabled = (currentSoalIndex === 0);
        btnPrev.style.opacity = (currentSoalIndex === 0) ? '0.5' : '1';

        // Tombol Next mati di soal terakhir, ganti jadi Submit
        if(currentSoalIndex === totalSoal - 1) {
            btnNext.style.display = 'none';
            btnSubmit.style.display = 'block';
        } else {
            btnNext.style.display = 'block';
            btnSubmit.style.display = 'none';
        }

        // Update Info & Progress
        document.getElementById('counter-soal').innerText = `Soal ${currentSoalIndex + 1} / ${totalSoal}`;
        const persen = ((currentSoalIndex + 1) / totalSoal) * 100;
        document.getElementById('progressBar').style.width = `${persen}%`;
    }

    function cekJawabanTerisi(index) {
        const divSoal = document.getElementById(`soal-index-${index}`);
        const inputs = divSoal.querySelectorAll('input, textarea');
        let terisi = false;
        
        // Loop cek input
        inputs.forEach(input => {
            if(input.type === 'radio' || input.type === 'checkbox') {
                if(input.checked) terisi = true;
            } else if (input.tagName === 'TEXTAREA') {
                if(input.value.trim() !== '') terisi = true;
            }
        });
        return terisi;
    }

    // 4. KIRIM DATA FINAL
    document.getElementById('formUjian').addEventListener('submit', e => {
        e.preventDefault();
        if(!confirm("Yakin ingin mengumpulkan ujian?")) return;

        const btn = document.getElementById('btnSubmit');
        btn.innerHTML = "‚è≥ Mengirim...";
        btn.disabled = true;

        const formData = new FormData(document.getElementById('formUjian'));
        const finalData = new FormData();

        // Ambil Identitas
        finalData.append('Waktu', new Date().toLocaleString());
        finalData.append('Nama', document.getElementById('inputNama').value);
        finalData.append('Kelas', document.getElementById('inputKelas').value);
        finalData.append('Mapel', document.getElementById('judul-mapel').innerText);

        // Proses Jawaban (Logika Gabung Checkbox & Jodoh)
        // (Sama seperti kode sebelumnya, disederhanakan)
        const entries = formData.entries();
        const processedKeys = new Set();
        
        for(let [key, value] of entries) {
             let mainKey = key.includes('_row_') ? key.split('_row_')[0] : key;
             if(processedKeys.has(mainKey)) continue;

             const allValues = formData.getAll(key);
             if(key.includes('_row_')) { // Jodoh
                 let jodohArr = [];
                 document.querySelectorAll(`input[name^="${mainKey}"]`).forEach(inp => { if(inp.checked) jodohArr.push(inp.value); });
                 finalData.append(mainKey, jodohArr.join(', '));
             } else if(allValues.length > 1) { // Checkbox
                 finalData.append(key, allValues.join(', '));
             } else {
                 finalData.append(key, value);
             }
             processedKeys.add(mainKey);
        }

        fetch(scriptURL, { method: 'POST', body: finalData})
            .then(() => { alert("‚úÖ Berhasil!"); window.location.href = 'tugas.html'; })
            .catch(() => { alert("‚ùå Gagal!"); btn.disabled = false; btn.innerHTML = "Coba Lagi"; });
    });
</script>

</body>
</html>
